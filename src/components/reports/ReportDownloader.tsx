// src/components/reports/ReportDownloader.tsx
import React, { useState } from 'react';
import { Button } from '@/components/ui/button';
import { Dialog, DialogContent, DialogHeader, DialogTitle } from '@/components/ui/dialog';
import { Download, Image, FileText } from 'lucide-react';
import html2canvas from 'html2canvas';
import jsPDF from 'jspdf';
import { useToast } from '@/hooks/use-toast';

interface ReportDownloaderProps {
  targetElementId: string;
  filename: string;
  showText?: boolean;
}

// üî• Ìó¨Ìçº Ìï®Ïàò Ï†ïÏùò
const getElementValue = (element: Element): string => {
  const ariaLabel = element.getAttribute('aria-label');
  if (ariaLabel) return ariaLabel;

  const dataValue = element.getAttribute('data-value');
  if (dataValue) return dataValue;

  const textContent = element.textContent?.trim();
  if (textContent) return textContent;

  if (element instanceof HTMLSelectElement) {
    return element.value;
  }

  if (element instanceof HTMLInputElement) {
    return element.value;
  }

  return 'Î∞òÏûÖ';
};

const ReportDownloader: React.FC<ReportDownloaderProps> = ({
  targetElementId,
  filename,
  showText = true
}) => {
  const [downloading, setDownloading] = useState(false);
  const [isDialogOpen, setIsDialogOpen] = useState(false);
  const { toast } = useToast();

  const downloadAsImage = async () => {
    try {
      setDownloading(true);
      const element = document.getElementById(targetElementId);

      if (!element) {
        throw new Error('ÏöîÏÜåÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.');
      }

      // üî• Îã§Ïö¥Î°úÎìúÏö© ÌÅ¥ÎûòÏä§ Ï∂îÍ∞Ä
      const originalClasses = element.className;
      element.classList.add('download-optimized');

      const canvas = await html2canvas(element, {
        scale: 3,
        useCORS: true,
        allowTaint: true,
        backgroundColor: '#ffffff',
        removeContainer: false,
        scrollX: 0,
        scrollY: 0,
        foreignObjectRendering: false,
        logging: false,
        onclone: (clonedDoc, clonedElement) => {
          // üî• Îã§Ïö¥Î°úÎìú ÏµúÏ†ÅÌôî Ïä§ÌÉÄÏùº Ï†ÅÏö©
          const style = clonedDoc.createElement('style');
          style.textContent = `
            .download-optimized {
              background: white !important;
              color: black !important;
              font-family: Arial, sans-serif !important;
              padding: 16px !important;
              width: 800px !important;
              max-width: none !important;
              margin: 0 !important;
              font-size: 14px !important;
              line-height: 1.4 !important;
            }
            
            .download-optimized table {
              width: 100% !important;
              border-collapse: collapse !important;
              border: 2px solid #000 !important;
              margin: 8px 0 !important;
              table-layout: fixed !important;
            }
            
            .download-optimized th,
            .download-optimized td {
              border: 1px solid #000 !important;
              padding: 8px 4px !important;
              text-align: center !important;
              font-size: 12px !important;
              line-height: 1.3 !important;
              vertical-align: middle !important;
              word-wrap: break-word !important;
              background: white !important;
              color: black !important;
              height: auto !important;
              min-height: 28px !important;
              white-space: normal !important;
            }
            
            .download-optimized th {
              background: #f0f0f0 !important;
              font-weight: bold !important;
              font-size: 13px !important;
            }

            /* üî• Ìï©Í≥Ñ Ìñâ Í∏∞Î≥∏ Ïä§ÌÉÄÏùº - ÎùºÎ≤®ÏùÄ ÏûëÍ≤å */
            .download-optimized .bg-gray-100 td,
            .download-optimized .bg-blue-50 td {
              font-size: 14px !important;
              font-weight: bold !important;
              background: #e0e0e0 !important;
              color: #000 !important;
            }

            /* üî• "Ìï©Í≥Ñ", "Ï¥ùÌöüÏàò", "Ï¥ùÏï°" ÎùºÎ≤®ÏùÄ ÏûëÍ≤å Ïú†ÏßÄ */
            .download-optimized .bg-gray-100 td:first-child,
            .download-optimized .bg-blue-50 td:first-child,
            .download-optimized .bg-gray-100 td:nth-child(3),
            .download-optimized .bg-blue-50 td:nth-child(3),
            .download-optimized .bg-gray-100 td:nth-child(5),
            .download-optimized .bg-blue-50 td:nth-child(5) {
              font-size: 14px !important;
              font-weight: bold !important;
            }

            /* üî• Ïà´Ïûê ÏÖÄÎßå ÌÅ¨Í≤å */
            .download-optimized .bg-gray-100 td:nth-child(2),
            .download-optimized .bg-gray-100 td:nth-child(4),
            .download-optimized .bg-gray-100 td:nth-child(6),
            .download-optimized .bg-blue-50 td:nth-child(2),
            .download-optimized .bg-blue-50 td:nth-child(4),
            .download-optimized .bg-blue-50 td:nth-child(6) {
              font-size: 24px !important;
              font-weight: 900 !important;
              color: #000 !important;
            }
            
            /* ÏùºÍ∞ÑÎ≥¥Í≥†ÏÑú Ïª¨Îüº ÎÑàÎπÑ */
            .download-optimized table:not([style*="table-layout: fixed"]) th:nth-child(1),
            .download-optimized table:not([style*="table-layout: fixed"]) td:nth-child(1) { width: 80px !important; }
            .download-optimized table:not([style*="table-layout: fixed"]) th:nth-child(2),
            .download-optimized table:not([style*="table-layout: fixed"]) td:nth-child(2) { width: 100px !important; }
            .download-optimized table:not([style*="table-layout: fixed"]) th:nth-child(3),
            .download-optimized table:not([style*="table-layout: fixed"]) td:nth-child(3) { width: 120px !important; }
            .download-optimized table:not([style*="table-layout: fixed"]) th:nth-child(4),
            .download-optimized table:not([style*="table-layout: fixed"]) td:nth-child(4) { width: 120px !important; }
            .download-optimized table:not([style*="table-layout: fixed"]) th:nth-child(5),
            .download-optimized table:not([style*="table-layout: fixed"]) td:nth-child(5) { width: 90px !important; }
            .download-optimized table:not([style*="table-layout: fixed"]) th:nth-child(6),
            .download-optimized table:not([style*="table-layout: fixed"]) td:nth-child(6) { width: 60px !important; }
            .download-optimized table:not([style*="table-layout: fixed"]) th:nth-child(7),
            .download-optimized table:not([style*="table-layout: fixed"]) td:nth-child(7) { width: 100px !important; }
            
            /* Ï≤≠Íµ¨ÏÑú Ïª¨Îüº ÎÑàÎπÑ ÏµúÏ†ÅÌôî */
            .download-optimized table[style*="table-layout: fixed"] th:nth-child(1),
            .download-optimized table[style*="table-layout: fixed"] td:nth-child(1) { width: 80px !important; }
            .download-optimized table[style*="table-layout: fixed"] th:nth-child(2),
            .download-optimized table[style*="table-layout: fixed"] td:nth-child(2) { width: 140px !important; }
            .download-optimized table[style*="table-layout: fixed"] th:nth-child(3),
            .download-optimized table[style*="table-layout: fixed"] td:nth-child(3) { width: 90px !important; }
            .download-optimized table[style*="table-layout: fixed"] th:nth-child(4),
            .download-optimized table[style*="table-layout: fixed"] td:nth-child(4) { width: 50px !important; }
            .download-optimized table[style*="table-layout: fixed"] th:nth-child(5),
            .download-optimized table[style*="table-layout: fixed"] td:nth-child(5) { width: 100px !important; }
            .download-optimized table[style*="table-layout: fixed"] th:nth-child(6),
            .download-optimized table[style*="table-layout: fixed"] td:nth-child(6) { width: 120px !important; }
            .download-optimized table[style*="table-layout: fixed"] th:nth-child(7),
            .download-optimized table[style*="table-layout: fixed"] td:nth-child(7) { width: 70px !important; }
            
            /* Select ÎìúÎ°≠Îã§Ïö¥ ÏöîÏÜåÎ•º ÌÖçÏä§Ìä∏Î°ú Î≥ÄÌôò */
            .download-optimized select,
            .download-optimized button[role="combobox"],
            .download-optimized [data-radix-select-trigger] {
              appearance: none !important;
              background: transparent !important;
              border: none !important;
              outline: none !important;
              box-shadow: none !important;
              padding: 4px !important;
              font-size: 12px !important;
              font-weight: normal !important;
              color: black !important;
              text-align: center !important;
              display: block !important;
              width: 100% !important;
              height: auto !important;
              line-height: 1.3 !important;
            }
            
            .download-optimized select:after,
            .download-optimized select:before,
            .download-optimized button[role="combobox"]:after,
            .download-optimized button[role="combobox"]:before,
            .download-optimized [data-radix-select-trigger]:after,
            .download-optimized [data-radix-select-trigger]:before,
            .download-optimized [data-radix-select-icon],
            .download-optimized svg {
              display: none !important;
              visibility: hidden !important;
            }
            
            .download-optimized .text-lg { font-size: 18px !important; font-weight: bold !important; }
            .download-optimized .text-xl { font-size: 20px !important; font-weight: bold !important; }
            
            .download-optimized * {
              box-shadow: none !important;
              text-shadow: none !important;
              color: #000 !important;
            }
          `;

          // üî• ÌÅ¥Î°†Îêú Î¨∏ÏÑúÏóêÏÑú Select ÏöîÏÜåÎ•º ÌÖçÏä§Ìä∏Î°ú Î≥ÄÌôò
          const selectElements = clonedElement.querySelectorAll('select, button[role="combobox"], [data-radix-select-trigger]');
          selectElements.forEach(select => {
            const value = getElementValue(select);

            const textSpan = clonedDoc.createElement('span');
            textSpan.textContent = value;
            textSpan.style.cssText = `
              font-size: 11px !important;
              font-weight: bold !important;
              color: #000 !important;
              text-align: center !important;
              display: block !important;
              width: 100% !important;
              padding: 2px !important;
              line-height: 1.2 !important;
            `;

            if (select.parentNode) {
              select.parentNode.replaceChild(textSpan, select);
            }
          });

          clonedDoc.head.appendChild(style);
        }
      });

      // üî• ÏõêÎûò ÌÅ¥ÎûòÏä§ Î≥µÏõê
      element.className = originalClasses;

      const imgData = canvas.toDataURL('image/png', 1.0);
      const link = document.createElement('a');
      link.download = `${filename}.png`;
      link.href = imgData;
      link.click();

      toast({
        title: "Îã§Ïö¥Î°úÎìú ÏôÑÎ£å",
        description: "Ïù¥ÎØ∏ÏßÄÍ∞Ä Îã§Ïö¥Î°úÎìúÎêòÏóàÏäµÎãàÎã§.",
      });
    } catch (error) {
      console.error('Image download error:', error);
      toast({
        title: "Îã§Ïö¥Î°úÎìú Ïã§Ìå®",
        description: "Ïù¥ÎØ∏ÏßÄ Îã§Ïö¥Î°úÎìú Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.",
        variant: "destructive",
      });
    } finally {
      setDownloading(false);
      setIsDialogOpen(false);
    }
  };

  const downloadAsPDF = async () => {
    try {
      setDownloading(true);
      const element = document.getElementById(targetElementId);

      if (!element) {
        throw new Error('ÏöîÏÜåÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.');
      }

      // üî• Î™®Î∞îÏùº ÎîîÎ∞îÏù¥Ïä§ Í≤ÄÏÇ¨
      const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
      const isSmallScreen = window.innerWidth <= 768;

      // üî• Ï≤≠Íµ¨ÏÑúÏù∏ÏßÄ ÏùºÍ∞ÑÎ≥¥Í≥†ÏÑúÏù∏ÏßÄ ÌôïÏù∏
      const isInvoiceReport = element.classList.contains('invoice-container') ||
        element.querySelector('.invoice-container') !== null;

      // üî• ÌÖåÏù¥Î∏î ÏöîÏÜå Ï∞æÍ∏∞
      const tables = element.querySelectorAll('table');
      const mainTable = Array.from(tables).find(table =>
        table.querySelector('tbody') &&
        table.querySelector('tbody')?.children.length > 0
      );

      if (!mainTable) {
        // ÌÖåÏù¥Î∏îÏù¥ ÏóÜÏúºÎ©¥ Í∏∞Ï°¥ Î∞©ÏãùÏúºÎ°ú Ï≤òÎ¶¨
        await downloadSinglePagePDF(element);
        return;
      }

      // üî• Ìñâ ÏàòÏóê Îî∞Îùº ÌéòÏù¥ÏßÄ Î∂ÑÌï† Ïó¨Î∂Ä Í≤∞Ï†ï - Î™®Î∞îÏùº Í≥†Î†§
      const tbody = mainTable.querySelector('tbody');
      const rowCount = tbody?.children.length || 0;

      // üî• Î™®Î∞îÏùºÏóêÏÑúÎäî Îçî Ï†ÅÏùÄ ÌñâÏúºÎ°ú Î∂ÑÌï†, Îç∞Ïä§ÌÅ¨ÌÜ±Î≥¥Îã§ Î≥¥ÏàòÏ†ÅÏúºÎ°ú ÏÑ§Ï†ï
      let maxRowsPerPage: number;
      if (isMobile || isSmallScreen) {
        // Î™®Î∞îÏùº: Ï≤≠Íµ¨ÏÑú 12Ìñâ, ÏùºÍ∞ÑÎ≥¥Í≥†ÏÑú 10Ìñâ
        maxRowsPerPage = isInvoiceReport ? 12 : 10;
      } else {
        // Îç∞Ïä§ÌÅ¨ÌÜ±: Ï≤≠Íµ¨ÏÑú 20Ìñâ, ÏùºÍ∞ÑÎ≥¥Í≥†ÏÑú 15Ìñâ
        maxRowsPerPage = isInvoiceReport ? 20 : 15;
      }

      if (rowCount <= maxRowsPerPage) {
        // Ìïú ÌéòÏù¥ÏßÄÎ°ú Ï∂©Î∂ÑÌïòÎ©¥ Í∏∞Ï°¥ Î∞©Ïãù
        await downloadSinglePagePDF(element);
      } else {
        // üî• Îã§Ï§ë ÌéòÏù¥ÏßÄ PDF ÏÉùÏÑ±
        await downloadMultiPagePDF(element, mainTable, maxRowsPerPage, isInvoiceReport, isMobile || isSmallScreen);
      }

    } catch (error) {
      console.error('PDF download error:', error);
      toast({
        title: "Îã§Ïö¥Î°úÎìú Ïã§Ìå®",
        description: "PDF Îã§Ïö¥Î°úÎìú Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.",
        variant: "destructive",
      });
    } finally {
      setDownloading(false);
      setIsDialogOpen(false);
    }
  };

  // üî• Îã®Ïùº ÌéòÏù¥ÏßÄ PDF Îã§Ïö¥Î°úÎìú
  const downloadSinglePagePDF = async (element: HTMLElement) => {
    const originalClasses = element.className;
    element.classList.add('download-optimized');

    const canvas = await html2canvas(element, {
      scale: 2,
      useCORS: true,
      allowTaint: true,
      backgroundColor: '#ffffff',
      removeContainer: false,
      scrollX: 0,
      scrollY: 0,
      foreignObjectRendering: false,
      logging: false,
      onclone: (clonedDoc, clonedElement) => {
        applyPDFStyles(clonedDoc, clonedElement);
      }
    });

    element.className = originalClasses;

    const imgData = canvas.toDataURL('image/png', 1.0);
    const pdf = new jsPDF('p', 'mm', 'a4');
    const pdfWidth = pdf.internal.pageSize.getWidth();
    const pdfHeight = pdf.internal.pageSize.getHeight();

    const imgWidth = canvas.width;
    const imgHeight = canvas.height;
    const ratio = Math.min((pdfWidth - 10) / imgWidth, (pdfHeight - 10) / imgHeight);
    const finalWidth = imgWidth * ratio;
    const finalHeight = imgHeight * ratio;
    const x = (pdfWidth - finalWidth) / 2;
    const y = 5;

    pdf.addImage(imgData, 'PNG', x, y, finalWidth, finalHeight);
    pdf.save(`${filename}.pdf`);

    toast({
      title: "Îã§Ïö¥Î°úÎìú ÏôÑÎ£å",
      description: "PDFÍ∞Ä Îã§Ïö¥Î°úÎìúÎêòÏóàÏäµÎãàÎã§.",
    });
  };

  // üî• Îã§Ï§ë ÌéòÏù¥ÏßÄ PDF Îã§Ïö¥Î°úÎìú - Î™®Î∞îÏùº ÏµúÏ†ÅÌôî
  const downloadMultiPagePDF = async (
    element: HTMLElement,
    mainTable: Element,
    maxRowsPerPage: number,
    isInvoiceReport: boolean,
    isMobileOrSmall: boolean
  ) => {
    const pdf = new jsPDF('p', 'mm', 'a4');
    const pdfWidth = pdf.internal.pageSize.getWidth();
    const pdfHeight = pdf.internal.pageSize.getHeight();

    // üî• Î™®Î∞îÏùºÏóêÏÑúÎäî Îçî ÏûëÏùÄ Ïó¨Î∞±Í≥º ÏµúÏ†ÅÌôîÎêú ÏÑ§Ï†ï
    const pageMargin = isMobileOrSmall ? 5 : 8;
    const availableHeight = pdfHeight - (pageMargin * 2);

    const tbody = mainTable.querySelector('tbody');
    if (!tbody) return;

    const rows = Array.from(tbody.children);
    const totalPages = Math.ceil(rows.length / maxRowsPerPage);

    for (let pageIndex = 0; pageIndex < totalPages; pageIndex++) {
      if (pageIndex > 0) {
        pdf.addPage();
      }

      // üî• ÌòÑÏû¨ ÌéòÏù¥ÏßÄÏö© ÏöîÏÜå ÏÉùÏÑ±
      const pageElement = element.cloneNode(true) as HTMLElement;
      pageElement.classList.add('download-optimized');

      // üî• Î™®Î∞îÏùº ÏµúÏ†ÅÌôî ÌÅ¥ÎûòÏä§ Ï∂îÍ∞Ä
      if (isMobileOrSmall) {
        pageElement.classList.add('mobile-optimized');
      }

      // üî• Ìó§Îçî Ï†ïÎ≥¥ Ïú†ÏßÄ (Ï≤≠Íµ¨ÏÑúÏùò Í≤ΩÏö∞)
      if (isInvoiceReport) {
        // ÌòÑÏû• Ï†ïÎ≥¥Îäî Ï≤´ ÌéòÏù¥ÏßÄÏóêÎßå ÌëúÏãú
        if (pageIndex > 0) {
          const siteInfoTables = pageElement.querySelectorAll('table');
          siteInfoTables.forEach((table, index) => {
            // Ï≤´ Î≤àÏß∏ ÌÖåÏù¥Î∏î(ÌòÑÏû•Ï†ïÎ≥¥)Îäî Ï≤´ ÌéòÏù¥ÏßÄ Ïù¥ÌõÑ Ïà®ÍπÄ
            if (index === 0) {
              table.style.display = 'none';
            }
          });
        }
      }

      // üî• ÌòÑÏû¨ ÌéòÏù¥ÏßÄÏóê Ìï¥ÎãπÌïòÎäî ÌñâÎì§Îßå ÌëúÏãú
      const pageTableBody = pageElement.querySelector('tbody');
      if (pageTableBody) {
        pageTableBody.innerHTML = '';

        const startIndex = pageIndex * maxRowsPerPage;
        const endIndex = Math.min(startIndex + maxRowsPerPage, rows.length);
        const pageRows = rows.slice(startIndex, endIndex);

        pageRows.forEach(row => {
          pageTableBody.appendChild(row.cloneNode(true));
        });
      }

      // üî• ÎßàÏßÄÎßâ ÌéòÏù¥ÏßÄÏóêÎßå Ìï©Í≥Ñ Ìñâ ÌëúÏãú
      if (pageIndex < totalPages - 1) {
        // ÎßàÏßÄÎßâ ÌéòÏù¥ÏßÄÍ∞Ä ÏïÑÎãàÎ©¥ Ìï©Í≥Ñ Ìñâ Ïà®ÍπÄ
        const summaryRows = pageElement.querySelectorAll('.bg-gray-100, .bg-blue-50');
        summaryRows.forEach(row => {
          if (row.parentElement) {
            row.parentElement.removeChild(row);
          }
        });
      }

      // üî• ÌéòÏù¥ÏßÄ Î≤àÌò∏ Ï∂îÍ∞Ä
      const pageInfo = document.createElement('div');
      pageInfo.style.cssText = `
        text-align: center;
        font-size: ${isMobileOrSmall ? '10px' : '12px'};
        color: #666;
        margin-top: 8px;
        font-weight: bold;
        padding: 4px 0;
      `;
      pageInfo.textContent = `ÌéòÏù¥ÏßÄ ${pageIndex + 1} / ${totalPages}`;
      pageElement.appendChild(pageInfo);

      // üî• Ï∫îÎ≤ÑÏä§ ÏÉùÏÑ± - Î™®Î∞îÏùº ÏµúÏ†ÅÌôî
      const canvasScale = isMobileOrSmall ? 1.5 : 2; // Î™®Î∞îÏùºÏóêÏÑúÎäî Ïä§ÏºÄÏùº ÎÇÆÏ∂§
      const canvas = await html2canvas(pageElement, {
        scale: canvasScale,
        useCORS: true,
        allowTaint: true,
        backgroundColor: '#ffffff',
        removeContainer: false,
        scrollX: 0,
        scrollY: 0,
        foreignObjectRendering: false,
        logging: false,
        width: isMobileOrSmall ? 800 : undefined, // Î™®Î∞îÏùºÏóêÏÑúÎäî Í≥†Ï†ï ÎÑàÎπÑ
        height: undefined, // ÎÜíÏù¥Îäî ÏûêÎèô
        onclone: (clonedDoc, clonedElement) => {
          applyPDFStyles(clonedDoc, clonedElement, true, isMobileOrSmall);
        }
      });

      // üî• PDFÏóê Ïù¥ÎØ∏ÏßÄ Ï∂îÍ∞Ä - Î™®Î∞îÏùº ÏµúÏ†ÅÌôî
      const imgData = canvas.toDataURL('image/png', 0.95); // ÌíàÏßà ÏïΩÍ∞Ñ ÎÇÆÏ∂§
      const imgWidth = canvas.width;
      const imgHeight = canvas.height;

      // üî• Î™®Î∞îÏùºÏóêÏÑúÎäî Îçî Î≥¥ÏàòÏ†ÅÏù∏ ÎπÑÏú® Í≥ÑÏÇ∞
      const maxWidth = pdfWidth - (pageMargin * 2);
      const maxHeight = availableHeight;
      const ratio = Math.min(maxWidth / imgWidth, maxHeight / imgHeight);

      const finalWidth = imgWidth * ratio;
      const finalHeight = imgHeight * ratio;
      const x = (pdfWidth - finalWidth) / 2;
      const y = pageMargin;

      pdf.addImage(imgData, 'PNG', x, y, finalWidth, finalHeight);
    }

    pdf.save(`${filename}.pdf`);

    toast({
      title: "Îã§Ïö¥Î°úÎìú ÏôÑÎ£å",
      description: `PDFÍ∞Ä ${totalPages}ÌéòÏù¥ÏßÄÎ°ú Îã§Ïö¥Î°úÎìúÎêòÏóàÏäµÎãàÎã§.`,
    });
  };

  // üî• PDFÏö© Ïä§ÌÉÄÏùº Ï†ÅÏö© Ìï®Ïàò - Î™®Î∞îÏùº ÏµúÏ†ÅÌôî Ï∂îÍ∞Ä
  const applyPDFStyles = (
    clonedDoc: Document,
    clonedElement: HTMLElement,
    isMultiPage: boolean = false,
    isMobileOrSmall: boolean = false
  ) => {
    const style = clonedDoc.createElement('style');

    // üî• Î™®Î∞îÏùº ÏµúÏ†ÅÌôîÎêú Ïä§ÌÉÄÏùº
    const baseFontSize = isMobileOrSmall ? '14px' : '16px';
    const cellPadding = isMobileOrSmall ? '8px 4px' : '10px 6px';
    const tableBorder = isMobileOrSmall ? '2px solid #000' : '3px solid #000';
    const cellBorder = isMobileOrSmall ? '1px solid #000' : '2px solid #000';

    style.textContent = `
      .download-optimized {
        background: white !important;
        color: black !important;
        font-family: Arial, sans-serif !important;
        padding: ${isMobileOrSmall ? '15px' : '20px'} !important;
        width: ${isMobileOrSmall ? '750px' : '900px'} !important;
        max-width: none !important;
        margin: 0 !important;
        font-size: ${baseFontSize} !important;
        line-height: 1.4 !important;
      }
      
      .download-optimized table {
        width: 100% !important;
        border-collapse: collapse !important;
        border: ${tableBorder} !important;
        margin: ${isMobileOrSmall ? '8px 0' : '10px 0'} !important;
        table-layout: fixed !important;
      }
      
      .download-optimized th,
      .download-optimized td {
        border: ${cellBorder} !important;
        padding: ${cellPadding} !important;
        text-align: center !important;
        font-size: ${isMobileOrSmall ? '12px' : '14px'} !important;
        line-height: 1.4 !important;
        vertical-align: middle !important;
        word-wrap: break-word !important;
        background: white !important;
        color: black !important;
        height: auto !important;
        min-height: ${isMobileOrSmall ? '28px' : '32px'} !important;
        white-space: normal !important;
      }
      
      .download-optimized th {
        background: #e0e0e0 !important;
        font-weight: bold !important;
        font-size: ${isMobileOrSmall ? '13px' : '15px'} !important;
      }

      /* üî• Ìï©Í≥Ñ Ìñâ Í∏∞Î≥∏ Ïä§ÌÉÄÏùº - ÎùºÎ≤®ÏùÄ ÏûëÍ≤å */
      .download-optimized .bg-gray-100 td,
      .download-optimized .bg-blue-50 td {
        font-size: ${isMobileOrSmall ? '14px' : '16px'} !important;
        font-weight: bold !important;
        background: #e0e0e0 !important;
        color: #000 !important;
      }

      /* üî• "Ìï©Í≥Ñ", "Ï¥ùÌöüÏàò", "Ï¥ùÏï°" ÎùºÎ≤®ÏùÄ ÏûëÍ≤å Ïú†ÏßÄ */
      .download-optimized .bg-gray-100 td:first-child,
      .download-optimized .bg-blue-50 td:first-child,
      .download-optimized .bg-gray-100 td:nth-child(3),
      .download-optimized .bg-blue-50 td:nth-child(3),
      .download-optimized .bg-gray-100 td:nth-child(5),
      .download-optimized .bg-blue-50 td:nth-child(5) {
        font-size: ${isMobileOrSmall ? '14px' : '16px'} !important;
        font-weight: bold !important;
      }

      /* üî• Ïà´Ïûê ÏÖÄÎßå ÌÅ¨Í≤å - Î™®Î∞îÏùºÏóêÏÑúÎäî ÏÉÅÎåÄÏ†ÅÏúºÎ°ú ÏûëÍ≤å */
      .download-optimized .bg-gray-100 td:nth-child(2),
      .download-optimized .bg-gray-100 td:nth-child(4),
      .download-optimized .bg-gray-100 td:nth-child(6),
      .download-optimized .bg-blue-50 td:nth-child(2),
      .download-optimized .bg-blue-50 td:nth-child(4),
      .download-optimized .bg-blue-50 td:nth-child(6) {
        font-size: ${isMobileOrSmall ? '22px' : '28px'} !important;
        font-weight: 900 !important;
        color: #000 !important;
      }
      
      /* üî• Ï≤≠Íµ¨ÏÑú Ï†úÎ™© ÌÅ¨Í∏∞ ÌôïÎåÄ - Î™®Î∞îÏùº ÏµúÏ†ÅÌôî */
      .download-optimized td[colspan="7"] {
        font-size: ${isMobileOrSmall ? '20px' : '26px'} !important;
        font-weight: 900 !important;
        padding: ${isMobileOrSmall ? '12px' : '15px'} !important;
      }

      /* üî• ÌòÑÏû•Î™Ö Í∏ÄÏî® ÌÅ¨Í∏∞ ÌôïÎåÄ - Î™®Î∞îÏùº ÏµúÏ†ÅÌôî */
      .download-optimized .text-lg {
        font-size: ${isMobileOrSmall ? '18px' : '22px'} !important;
        font-weight: 900 !important;
      }
      
      /* Ï≤≠Íµ¨ÏÑú Ïª¨Îüº ÎÑàÎπÑ ÏµúÏ†ÅÌôî - Î™®Î∞îÏùº Ï°∞Ï†ï */
      .download-optimized table[style*="table-layout: fixed"] th:nth-child(1),
      .download-optimized table[style*="table-layout: fixed"] td:nth-child(1) { 
        width: ${isMobileOrSmall ? '85px' : '90px'} !important; 
      }
      .download-optimized table[style*="table-layout: fixed"] th:nth-child(2),
      .download-optimized table[style*="table-layout: fixed"] td:nth-child(2) { 
        width: ${isMobileOrSmall ? '140px' : '160px'} !important; 
     }
     .download-optimized table[style*="table-layout: fixed"] th:nth-child(3),
     .download-optimized table[style*="table-layout: fixed"] td:nth-child(3) { 
       width: ${isMobileOrSmall ? '85px' : '100px'} !important; 
     }
     .download-optimized table[style*="table-layout: fixed"] th:nth-child(4),
     .download-optimized table[style*="table-layout: fixed"] td:nth-child(4) { 
       width: ${isMobileOrSmall ? '50px' : '60px'} !important; 
     }
     .download-optimized table[style*="table-layout: fixed"] th:nth-child(5),
     .download-optimized table[style*="table-layout: fixed"] td:nth-child(5) { 
       width: ${isMobileOrSmall ? '95px' : '110px'} !important; 
     }
     .download-optimized table[style*="table-layout: fixed"] th:nth-child(6),
     .download-optimized table[style*="table-layout: fixed"] td:nth-child(6) { 
       width: ${isMobileOrSmall ? '110px' : '130px'} !important; 
     }
     .download-optimized table[style*="table-layout: fixed"] th:nth-child(7),
     .download-optimized table[style*="table-layout: fixed"] td:nth-child(7) { 
       width: ${isMobileOrSmall ? '70px' : '80px'} !important; 
     }

     /* üî• ÏùºÍ∞ÑÎ≥¥Í≥†ÏÑú Ïª¨Îüº ÎÑàÎπÑ - Î™®Î∞îÏùº ÏµúÏ†ÅÌôî */
     .download-optimized table:not([style*="table-layout: fixed"]) th:nth-child(1),
     .download-optimized table:not([style*="table-layout: fixed"]) td:nth-child(1) { 
       width: ${isMobileOrSmall ? '70px' : '80px'} !important; 
     }
     .download-optimized table:not([style*="table-layout: fixed"]) th:nth-child(2),
     .download-optimized table:not([style*="table-layout: fixed"]) td:nth-child(2) { 
       width: ${isMobileOrSmall ? '90px' : '100px'} !important; 
     }
     .download-optimized table:not([style*="table-layout: fixed"]) th:nth-child(3),
     .download-optimized table:not([style*="table-layout: fixed"]) td:nth-child(3) { 
       width: ${isMobileOrSmall ? '110px' : '120px'} !important; 
     }
     .download-optimized table:not([style*="table-layout: fixed"]) th:nth-child(4),
     .download-optimized table:not([style*="table-layout: fixed"]) td:nth-child(4) { 
       width: ${isMobileOrSmall ? '110px' : '120px'} !important; 
     }
     .download-optimized table:not([style*="table-layout: fixed"]) th:nth-child(5),
     .download-optimized table:not([style*="table-layout: fixed"]) td:nth-child(5) { 
       width: ${isMobileOrSmall ? '80px' : '90px'} !important; 
     }
     .download-optimized table:not([style*="table-layout: fixed"]) th:nth-child(6),
     .download-optimized table:not([style*="table-layout: fixed"]) td:nth-child(6) { 
       width: ${isMobileOrSmall ? '55px' : '60px'} !important; 
     }
     .download-optimized table:not([style*="table-layout: fixed"]) th:nth-child(7),
     .download-optimized table:not([style*="table-layout: fixed"]) td:nth-child(7) { 
       width: ${isMobileOrSmall ? '90px' : '100px'} !important; 
     }
     
     /* Select ÎìúÎ°≠Îã§Ïö¥ ÏöîÏÜåÎ•º ÌÖçÏä§Ìä∏Î°ú Î≥ÄÌôò */
     .download-optimized select,
     .download-optimized button[role="combobox"],
     .download-optimized [data-radix-select-trigger] {
       appearance: none !important;
       background: transparent !important;
       border: none !important;
       outline: none !important;
       box-shadow: none !important;
       padding: ${isMobileOrSmall ? '4px' : '6px'} !important;
       font-size: ${isMobileOrSmall ? '11px' : '13px'} !important;
       font-weight: bold !important;
       color: black !important;
       text-align: center !important;
       display: block !important;
       width: 100% !important;
       height: auto !important;
       line-height: 1.3 !important;
     }
     
     .download-optimized select:after,
     .download-optimized select:before,
     .download-optimized button[role="combobox"]:after,
     .download-optimized button[role="combobox"]:before,
     .download-optimized [data-radix-select-trigger]:after,
     .download-optimized [data-radix-select-trigger]:before,
     .download-optimized [data-radix-select-icon],
     .download-optimized svg {
       display: none !important;
       visibility: hidden !important;
     }
     
     .download-optimized * { color: #000 !important; }

     /* üî• Î™®Î∞îÏùº Ï∂îÍ∞Ä ÏµúÏ†ÅÌôî */
     ${isMobileOrSmall ? `
       .download-optimized {
         max-width: 750px !important;
         overflow-x: visible !important;
       }
       
       .download-optimized table {
         font-size: 11px !important;
       }
       
       .download-optimized th,
       .download-optimized td {
         padding: 6px 3px !important;
         font-size: 11px !important;
         line-height: 1.2 !important;
       }
       
       .download-optimized th {
         font-size: 12px !important;
       }
       
       /* ÌéòÏù¥ÏßÄ Ï†ïÎ≥¥ Ïä§ÌÉÄÏùº */
       .download-optimized div:last-child {
         font-size: 10px !important;
         margin-top: 6px !important;
         padding: 3px 0 !important;
       }
     ` : ''}
   `;

    // üî• ÌÅ¥Î°†Îêú Î¨∏ÏÑúÏóêÏÑú Select ÏöîÏÜåÎ•º ÌÖçÏä§Ìä∏Î°ú Î≥ÄÌôò
    const selectElements = clonedElement.querySelectorAll('select, button[role="combobox"], [data-radix-select-trigger]');
    selectElements.forEach(select => {
      const value = getElementValue(select);

      const textSpan = clonedDoc.createElement('span');
      textSpan.textContent = value;
      textSpan.style.cssText = `
       font-size: ${isMobileOrSmall ? '10px' : '13px'} !important;
       font-weight: bold !important;
       color: #000 !important;
       text-align: center !important;
       display: block !important;
       width: 100% !important;
       padding: ${isMobileOrSmall ? '3px' : '4px'} !important;
       line-height: 1.3 !important;
     `;

      if (select.parentNode) {
        select.parentNode.replaceChild(textSpan, select);
      }
    });

    clonedDoc.head.appendChild(style);
  };

  const handlePrint = () => {
    setTimeout(() => {
      window.print();
    }, 100);
    setIsDialogOpen(false);
  };

  const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

  if (isMobile) {
    return (
      <>
        <Button
          variant="outline"
          size="sm"
          onClick={() => setIsDialogOpen(true)}
          disabled={downloading}
          className="no-print"
        >
          <Download className="h-4 w-4 mr-2" />
          {downloading ? 'Ï≤òÎ¶¨ Ï§ë...' : showText ? 'Îã§Ïö¥Î°úÎìú' : ''}
        </Button>

        <Dialog open={isDialogOpen} onOpenChange={setIsDialogOpen}>
          <DialogContent className="sm:max-w-md">
            <DialogHeader>
              <DialogTitle className="text-sm">Îã§Ïö¥Î°úÎìú ÏòµÏÖò</DialogTitle>
            </DialogHeader>
            <div className="space-y-3 py-2">
              <Button
                onClick={downloadAsImage}
                disabled={downloading}
                className="w-full justify-start"
              >
                <Image className="h-4 w-4 mr-2" />
                PNG Ïù¥ÎØ∏ÏßÄÎ°ú Îã§Ïö¥Î°úÎìú
              </Button>
              <Button
                onClick={downloadAsPDF}
                disabled={downloading}
                className="w-full justify-start"
              >
                <FileText className="h-4 w-4 mr-2" />
                PDFÎ°ú Îã§Ïö¥Î°úÎìú (Í∂åÏû•)
              </Button>
              <Button
                variant="outline"
                onClick={() => setIsDialogOpen(false)}
                className="w-full"
              >
                Ï∑®ÏÜå
              </Button>
            </div>
            {downloading && (
              <div className="text-center py-4">
                <div className="animate-spin inline-block h-6 w-6 border-2 border-blue-500 border-t-transparent rounded-full"></div>
                <p className="mt-2 text-gray-500 text-sm">
                  {downloading ? 'Îã§Ïö¥Î°úÎìú Ï≤òÎ¶¨ Ï§ë...' : ''}
                </p>
              </div>
            )}
          </DialogContent>
        </Dialog>
      </>
    );
  }

  return (
    <Button
      variant="outline"
      size="sm"
      onClick={handlePrint}
      className="no-print"
    >
      <Download className="h-4 w-4 mr-2" />
      {showText ? 'Ïù∏ÏáÑ' : ''}
    </Button>
  );
};

export default ReportDownloader;